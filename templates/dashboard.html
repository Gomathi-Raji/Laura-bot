<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laura-bot Learning Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-connected { background-color: #28a745; }
        .status-simulation { background-color: #ffc107; }
        .status-disconnected { background-color: #dc3545; }
        
        .learning-mode-card {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
        }
        
        .quiz-card {
            background: linear-gradient(45deg, #A8E6CF, #88D8A3);
            color: #2d5a41;
        }
        
        .progress-card {
            background: linear-gradient(45deg, #FFD93D, #FF6B6B);
            color: white;
        }
        
        .hardware-card {
            background: linear-gradient(45deg, #6C5CE7, #A29BFE);
            color: white;
        }
        
        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body data-subjects="{{ available_subjects|join(',') if available_subjects else '' }}" data-hardware-status="{{ 'true' if hardware_status else 'false' }}">
    <nav class="navbar navbar-expand-lg navbar-dark bg-transparent">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot me-2"></i>Laura-bot Learning Assistant
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span class="status-indicator status-{{ 'connected' if hardware_status == 'connected' else 'simulation' }}"></span>
                    {{ 'Hardware Connected' if hardware_status == 'connected' else 'Simulation Mode' }}
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h1 class="text-white mb-3">
                    <i class="fas fa-graduation-cap me-3"></i>
                    Personal Learning Dashboard
                </h1>
                <p class="text-white-50">AI-powered learning with Arduino hardware integration</p>
            </div>
        </div>

        <div class="row g-4">
            <!-- Learning Mode Card -->
            <div class="col-md-6 col-lg-3">
                <div class="card dashboard-card learning-mode-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-brain fa-3x mb-3"></i>
                        <h5 class="card-title">Learning Mode</h5>
                        <p class="card-text">Interactive AI tutoring with voice and hardware feedback</p>
                        <a href="/learn" class="btn btn-light btn-lg">
                            <i class="fas fa-play me-2"></i>Start Learning
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quiz System Card -->
            <div class="col-md-6 col-lg-3">
                <div class="card dashboard-card quiz-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-question-circle fa-3x mb-3"></i>
                        <h5 class="card-title">Smart Quiz System</h5>
                        <p class="card-text">Adaptive quizzes with AI-generated questions</p>
                        <button class="btn btn-dark btn-lg" onclick="startQuickQuiz()">
                            <i class="fas fa-rocket me-2"></i>Quick Quiz
                        </button>
                    </div>
                </div>
            </div>

            <!-- Progress Analytics Card -->
            <div class="col-md-6 col-lg-3">
                <div class="card dashboard-card progress-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <h5 class="card-title">Progress Analytics</h5>
                        <p class="card-text">Detailed learning statistics and insights</p>
                        <a href="/progress" class="btn btn-light btn-lg">
                            <i class="fas fa-analytics me-2"></i>View Progress
                        </a>
                    </div>
                </div>
            </div>

            <!-- Hardware Control Card -->
            <div class="col-md-6 col-lg-3">
                <div class="card dashboard-card hardware-card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-microchip fa-3x mb-3"></i>
                        <h5 class="card-title">Hardware Control</h5>
                        <p class="card-text">Arduino servo control and voice interaction</p>
                        <a href="/hardware" class="btn btn-light btn-lg">
                            <i class="fas fa-cogs me-2"></i>Control Hardware
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status Row -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>System Status</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Hardware:</strong>
                                <span class="badge bg-{{ 'success' if hardware_status == 'connected' else 'warning' }} ms-2">
                                    {{ 'Connected' if hardware_status == 'connected' else 'Simulation' }}
                                </span>
                            </div>
                            <div class="col-md-3">
                                <strong>Learning Mode:</strong>
                                <span class="badge bg-info ms-2" id="learning-mode-status">{{ session.learning_mode|title }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Current User:</strong>
                                <span class="text-primary ms-2" id="current-user">{{ session.user_name }}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Available Subjects:</strong>
                                <span class="badge bg-secondary ms-2">{{ available_subjects|length }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Subjects -->
        {% if available_subjects %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-books me-2"></i>Available Learning Subjects</h5>
                        <div class="row">
                            {% for subject in available_subjects %}
                            <div class="col-md-2 col-sm-4 col-6 mb-2">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="selectSubject('{{ subject }}')">
                                    <i class="fas fa-book me-1"></i>{{ subject }}
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Voice Interaction Button -->
    <button class="floating-action-btn" id="voiceBtn" onclick="toggleVoiceInteraction()" title="Voice Interaction">
        <i class="fas fa-microphone" id="voiceIcon"></i>
    </button>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize SocketIO connection
        const socket = io();
        let isListening = false;

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
            showToast('Connected to Laura-bot', 'success');
        });

        socket.on('status_update', function(data) {
            updateStatusDisplay(data);
        });

        socket.on('voice_response', function(data) {
            showToast(`Voice Response: ${data.ai_response.substring(0, 100)}...`, 'info');
            isListening = false;
            updateVoiceButton();
        });

        socket.on('voice_error', function(data) {
            showToast(`Voice Error: ${data.error}`, 'danger');
            isListening = false;
            updateVoiceButton();
        });

        // Voice interaction functions
        function toggleVoiceInteraction() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            fetch('/api/voice_interaction', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'start_listening'})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isListening = true;
                    updateVoiceButton();
                    showToast('Listening for voice input...', 'info');
                }
            })
            .catch(error => {
                console.error('Voice interaction error:', error);
                showToast('Voice interaction failed', 'danger');
            });
        }

        function stopListening() {
            fetch('/api/voice_interaction', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'stop_listening'})
            })
            .then(response => response.json())
            .then(data => {
                isListening = false;
                updateVoiceButton();
                showToast('Voice interaction stopped', 'warning');
            });
        }

        function updateVoiceButton() {
            const btn = document.getElementById('voiceBtn');
            const icon = document.getElementById('voiceIcon');
            
            if (isListening) {
                btn.style.background = 'linear-gradient(45deg, #ff4757, #ff3838)';
                btn.classList.add('pulse');
                icon.className = 'fas fa-stop';
            } else {
                btn.style.background = 'linear-gradient(45deg, #FF6B6B, #4ECDC4)';
                btn.classList.remove('pulse');
                icon.className = 'fas fa-microphone';
            }
        }

        // Simple dashboard initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Basic setup for the dashboard
            console.log('Laura-bot Dashboard initialized');
        });

        // Subject selection
        function selectSubject(subject) {
            fetch('/api/start_session', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_name: document.getElementById('current-user').textContent,
                    subject: subject
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`${subject} learning session started!`, 'success');
                    setTimeout(() => {
                        window.location.href = '/learn';
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Session start error:', error);
                showToast('Failed to start session', 'danger');
            });
        }

        // Utility functions
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        function updateStatusDisplay(data) {
            if (data.session) {
                document.getElementById('learning-mode-status').textContent = data.session.learning_mode;
                document.getElementById('current-user').textContent = data.session.user_name;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Request initial status
            socket.emit('request_status');
            
            // Update voice button state
            updateVoiceButton();
        });
    </script>
</body>
</html>
